<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOVR Musik - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --sovr-primary: #ff7a00;
            --sovr-bg: #09090b;
            --sovr-card: #18181b;
        }

        body {
            background-color: var(--sovr-bg);
            color: #e4e4e7;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow: hidden;
        }

        .sidebar-active {
            background: linear-gradient(to right, rgba(255, 122, 0, 0.1), transparent);
            border-left: 4px solid var(--sovr-primary);
            color: white;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        input[type="range"] {
            accent-color: var(--sovr-primary);
        }

        /* Waveform visualization */
        .waveform-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            height: 24px;
        }

        .waveform-bar {
            width: 3px;
            background: linear-gradient(to top, #ff7a00, #ffaa55);
            border-radius: 2px;
            animation: wave 0.5s ease-in-out infinite alternate;
        }

        .waveform-bar:nth-child(1) { animation-delay: 0s; }
        .waveform-bar:nth-child(2) { animation-delay: 0.1s; }
        .waveform-bar:nth-child(3) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(4) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(5) { animation-delay: 0.15s; }

        @keyframes wave {
            from { height: 8px; }
            to { height: 24px; }
        }

        .waveform-paused .waveform-bar {
            animation-play-state: paused;
            height: 12px;
        }

        /* Now playing glow */
        .now-playing {
            background: linear-gradient(to right, rgba(255, 122, 0, 0.15), transparent) !important;
            border-left: 3px solid #ff7a00 !important;
        }

        /* Video thumbnail */
        .video-thumb {
            background: linear-gradient(135deg, #1a1a1a, #0a0a0a);
        }
    </style>
</head>

<body class="h-screen flex">

    <!-- Mobile Sidebar Backdrop -->
    <div id="sidebar-backdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 z-50 w-64 bg-zinc-950 border-r border-zinc-800 flex flex-col shadow-2xl md:shadow-none">
        <div class="p-6 flex justify-between items-center">
            <h1 class="text-2xl font-black italic tracking-tighter text-white">SOVR<span class="text-orange-500">MUSIK</span></h1>
            <button onclick="toggleSidebar()" class="md:hidden text-zinc-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <nav class="flex-1 px-4 py-4 space-y-1 overflow-y-auto">
            <button onclick="setView('dashboard'); toggleSidebar()"
                class="w-full flex items-center px-4 py-3 rounded-lg hover:bg-zinc-900 transition-colors group"
                id="nav-dashboard">
                <i class="fas fa-home mr-3 text-zinc-400 group-hover:text-orange-400"></i>
                <span class="font-medium">Dashboard</span>
            </button>
            <button onclick="setView('music'); toggleSidebar()"
                class="w-full flex items-center px-4 py-3 rounded-lg hover:bg-zinc-900 transition-colors group"
                id="nav-music">
                <i class="fas fa-music mr-3 text-zinc-400 group-hover:text-orange-400"></i>
                <span class="font-medium">Music Library</span>
            </button>
            <button onclick="setView('videos'); toggleSidebar()"
                class="w-full flex items-center px-4 py-3 rounded-lg hover:bg-zinc-900 transition-colors group"
                id="nav-videos">
                <i class="fas fa-film mr-3 text-zinc-400 group-hover:text-orange-400"></i>
                <span class="font-medium">Videos</span>
            </button>
            <button onclick="setView('playlists'); toggleSidebar()"
                class="w-full flex items-center px-4 py-3 rounded-lg hover:bg-zinc-900 transition-colors group"
                id="nav-playlists">
                <i class="fas fa-list mr-3 text-zinc-400 group-hover:text-orange-400"></i>
                <span class="font-medium">Playlists</span>
            </button>
        </nav>

        <div class="p-4 border-t border-zinc-800">
            <button onclick="triggerUpload()"
                class="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-orange-900/20 flex items-center justify-center">
                <i class="fas fa-cloud-upload-alt mr-2"></i> <span class="hidden md:inline">Upload</span><span class="md:hidden">Upload Media</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden w-full">

        <!-- Header with Search -->
        <header class="h-16 border-b border-zinc-800 flex items-center justify-between px-4 md:px-8 bg-zinc-950/50 backdrop-blur-sm z-10 shrink-0">
            <!-- Mobile Menu Toggle -->
            <button onclick="toggleSidebar()" class="mr-4 md:hidden text-zinc-400 hover:text-white">
                <i class="fas fa-bars text-xl"></i>
            </button>

            <div class="relative flex-1 max-w-sm mr-4">
                <input type="text" id="search-input" placeholder="Search..."
                    class="w-full bg-zinc-900 border border-zinc-800 rounded-full py-2 px-10 text-sm focus:outline-none focus:border-orange-500"
                    oninput="handleSearch(this.value)">
                <i class="fas fa-search absolute left-4 top-2.5 text-zinc-500 text-xs"></i>
                <button onclick="clearSearch()" id="clear-search"
                    class="absolute right-4 top-2 text-zinc-500 hover:text-white hidden">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>
            <div class="flex items-center space-x-3 md:space-x-4">
                <span id="library-count" class="text-xs text-zinc-500 hidden md:inline">Loading...</span>
                <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-xs font-bold text-white shrink-0">
                    SE
                </div>
            </div>
        </header>

        <!-- View Content Wrapper -->
        <div id="view-content" class="flex-1 overflow-y-auto p-4 md:p-8 scrollbar-hide pb-32">
            <!-- Dynamic views load here -->
        </div>

        <!-- Floating Player Bar -->
        <div id="audio-player-bar"
            class="absolute bottom-0 left-0 right-0 bg-zinc-950/95 backdrop-blur-md border-t border-zinc-800 p-2 md:p-4 transform translate-y-full transition-transform duration-300 z-50">
            <div class="max-w-6xl mx-auto flex items-center justify-between gap-2 md:gap-4">
                <!-- Track Info -->
                <div class="flex items-center w-auto md:w-1/4 min-w-0 mr-2 md:mr-0">
                    <img id="player-cover" src="https://placehold.co/64x64/111/ff7a00?text=â™ª"
                        class="w-10 h-10 md:w-12 md:h-12 rounded-lg bg-zinc-800 mr-3 object-cover shrink-0">
                    <div class="overflow-hidden min-w-0">
                        <div id="player-title" class="text-sm font-bold truncate">Not Playing</div>
                        <div id="player-artist" class="text-xs text-zinc-400 truncate">Select a track</div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex flex-col items-center flex-1 space-y-1 md:space-y-2">
                    <div class="flex items-center space-x-4 md:space-x-6">
                        <button onclick="toggleShuffle()" id="shuffle-btn" class="hidden md:inline text-zinc-400 hover:text-white"><i class="fas fa-random text-sm"></i></button>
                        <button onclick="playPrevious()" class="text-zinc-400 hover:text-white"><i class="fas fa-step-backward text-base md:text-lg"></i></button>
                        <button id="player-play-btn" onclick="togglePlay()"
                            class="w-8 h-8 md:w-10 md:h-10 bg-orange-500 text-black rounded-full flex items-center justify-center hover:scale-105 transition hover:bg-orange-400">
                            <i class="fas fa-play ml-1"></i>
                        </button>
                        <button onclick="playNext()" class="text-zinc-400 hover:text-white"><i class="fas fa-step-forward text-base md:text-lg"></i></button>
                        <button onclick="toggleRepeat()" id="repeat-btn" class="hidden md:inline text-zinc-400 hover:text-white"><i class="fas fa-redo text-sm"></i></button>
                    </div>
                    <!-- Progress Bar (Visible on mobile but compact) -->
                    <div class="flex items-center space-x-2 w-full max-w-lg md:px-0">
                        <span id="player-current" class="text-[9px] md:text-[10px] text-zinc-500 font-mono w-6 md:w-10 text-right">0:00</span>
                        <input id="player-seek" type="range" class="flex-1 h-1 bg-zinc-800 rounded-full appearance-none"
                            value="0" step="0.1" min="0" oninput="seekMedia(this.value)">
                        <span id="player-duration" class="text-[9px] md:text-[10px] text-zinc-500 font-mono w-6 md:w-10">0:00</span>
                    </div>
                </div>

                <!-- Volume & Queue (Hidden on Mobile) -->
                <div class="hidden md:flex items-center w-1/4 justify-end space-x-4">
                    <button onclick="toggleQueue()" class="text-zinc-400 hover:text-white" title="Queue"><i class="fas fa-list-ol"></i></button>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-volume-up text-zinc-400 text-xs"></i>
                        <input type="range" class="w-24 h-1 bg-zinc-800 rounded-full appearance-none" value="80"
                            step="1" min="0" max="100" oninput="setVolume(this.value/100)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Queue Panel -->
        <div id="queue-panel"
            class="absolute bottom-20 right-4 w-80 max-h-96 bg-zinc-900 border border-zinc-800 rounded-2xl shadow-2xl overflow-hidden z-50 hidden">
            <div class="p-4 border-b border-zinc-800">
                <h3 class="font-bold">Up Next</h3>
            </div>
            <div id="queue-list" class="overflow-y-auto max-h-72 p-2 scrollbar-hide"></div>
        </div>
    </main>

    <!-- Video Overlay -->
    <div id="video-overlay" class="fixed inset-0 bg-black z-[100] hidden flex flex-col items-center justify-center p-4">
        <button onclick="closeVideo()" class="absolute top-4 right-4 text-white text-3xl hover:text-red-500 z-10"><i class="fas fa-times"></i></button>
        <div class="w-full max-w-5xl aspect-video bg-zinc-900 rounded-2xl overflow-hidden shadow-2xl relative">
            <video id="global-video-player" controls class="w-full h-full object-contain"></video>
        </div>
        <h2 id="video-overlay-title" class="mt-4 md:mt-8 text-xl md:text-2xl font-bold text-center">Video Title</h2>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="file-upload" class="hidden" multiple accept="audio/*,video/*">
    <audio id="global-audio-player" class="hidden"></audio>

    <script>
        console.log('=== SOVR MUSIK v3 MOBILE ===');

        // ========== APP STATE ==========
        let currentView = 'dashboard';
        let mediaLibrary = [];
        let filteredLibrary = [];
        let searchQuery = '';
        let currentTrackIndex = -1;
        let playQueue = [];
        let isShuffled = false;
        let repeatMode = 0; // 0=off, 1=all, 2=one

        const audioPlayer = document.getElementById('global-audio-player');
        const videoPlayer = document.getElementById('global-video-player');
        const audioBar = document.getElementById('audio-player-bar');
        const waveform = document.getElementById('waveform');

        // ========== INITIALIZATION ==========
        window.onload = async () => {
            console.log('Window loaded, fetching tracks...');
            await loadTracksFromJSON();
            console.log('Tracks loaded:', mediaLibrary.length);
            setView('dashboard');
        };

        // UI Toggles
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');
            
            // Toggle transform class for mobile slide-in
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.add('hidden');
            }
        }

        // Load tracks directly from tracks.json
        async function loadTracksFromJSON() {
            try {
                const res = await fetch('tracks.json?v=' + Date.now());
                if (!res.ok) throw new Error('tracks.json not found');

                const tracks = await res.json();
                console.log('SOVR Musik: Loading', tracks.length, 'tracks...');

                mediaLibrary = tracks.map((track, index) => ({
                    id: index + 1,
                    name: track.title,
                    artist: track.artist || 'Tunee',
                    album: 'SOVR Empire',
                    type: track.src.endsWith('.mp4') ? 'video' : 'audio',
                    src: track.src,
                    coverArt: track.img,
                    isLocal: true
                }));

                filteredLibrary = [...mediaLibrary];
                updateLibraryCount();
                console.log('SOVR Musik: Loaded', mediaLibrary.length, 'tracks!');
            } catch (err) {
                console.error('Failed to load tracks:', err);
                mediaLibrary = [];
                filteredLibrary = [];
            }
        }

        function updateLibraryCount() {
            const total = mediaLibrary.length;
            document.getElementById('library-count').innerText = `${total} tracks`;
        }

        // ========== SEARCH ==========
        function handleSearch(query) {
            searchQuery = query.toLowerCase().trim();
            const clearBtn = document.getElementById('clear-search');
            clearBtn.classList.toggle('hidden', !searchQuery);

            if (!searchQuery) {
                filteredLibrary = [...mediaLibrary];
            } else {
                filteredLibrary = mediaLibrary.filter(item =>
                    item.name.toLowerCase().includes(searchQuery) ||
                    (item.artist && item.artist.toLowerCase().includes(searchQuery))
                );
            }
            renderCurrentView();
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            handleSearch('');
        }

        // ========== VIEW MANAGEMENT ==========
        function setView(view) {
            currentView = view;
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('sidebar-active', 'bg-zinc-900'));
            const activeBtn = document.getElementById(`nav-${view}`);
            if (activeBtn) activeBtn.classList.add('sidebar-active');
            renderCurrentView();
        }

        function renderCurrentView() {
            const container = document.getElementById('view-content');
            const audioTracks = filteredLibrary.filter(m => m.type === 'audio' || (m.type === 'video' && m.src));
            const videoTracks = filteredLibrary.filter(m => m.type === 'video');

            if (currentView === 'dashboard') {
                const recent = filteredLibrary.slice(0, 8);
                container.innerHTML = `
                    <h2 class="text-2xl md:text-3xl font-black mb-4 md:mb-6">Welcome Back</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8 md:mb-12">
                        <div class="bg-orange-600/10 border border-orange-500/20 p-4 md:p-6 rounded-2xl flex flex-col justify-between overflow-hidden relative">
                            <div>
                                <h3 class="text-lg md:text-xl font-bold mb-2">New Drop?</h3>
                                <p class="text-zinc-400 text-xs md:text-sm mb-4">Upload your latest creations.</p>
                                <button onclick="triggerUpload()" class="bg-orange-500 text-black px-4 md:px-5 py-2 rounded-full font-bold hover:scale-105 transition text-xs md:text-sm">Upload</button>
                            </div>
                            <i class="fas fa-compact-disc text-6xl md:text-7xl absolute -right-2 -bottom-2 text-orange-500/20 rotate-12"></i>
                        </div>
                        <div class="hidden md:block bg-zinc-900 border border-zinc-800 p-6 rounded-2xl">
                            <h3 class="text-lg font-bold mb-3">Library Stats</h3>
                            <div class="flex space-x-8">
                                <div>
                                    <div class="text-2xl font-black text-orange-500">${mediaLibrary.filter(m => m.type === 'audio' || m.src).length}</div>
                                    <div class="text-[10px] text-zinc-500 uppercase tracking-widest">Tracks</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-black text-orange-500">${mediaLibrary.filter(m => m.type === 'video').length}</div>
                                    <div class="text-[10px] text-zinc-500 uppercase tracking-widest">Videos</div>
                                </div>
                            </div>
                        </div>
                        <div class="hidden md:block bg-zinc-900 border border-zinc-800 p-6 rounded-2xl">
                            <h3 class="text-lg font-bold mb-3">Quick Play</h3>
                            <button onclick="shuffleAll()" class="bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-full text-sm flex items-center transition">
                                <i class="fas fa-random mr-2 text-orange-500"></i> Shuffle All
                            </button>
                        </div>
                    </div>
                    <h3 class="text-lg md:text-xl font-bold mb-3 md:mb-4">Recently Added</h3>
                    <div class="grid grid-cols-2 md:grid-cols-6 lg:grid-cols-8 gap-3">
                        ${recent.map((item, i) => renderGridCard(item, i)).join('')}
                    </div>
                `;
            } else if (currentView === 'music') {
                container.innerHTML = `
                    <div class="flex items-center justify-between mb-4 md:mb-6">
                        <h2 class="text-2xl md:text-3xl font-black tracking-tight">Music Library</h2>
                        <div class="flex items-center space-x-4">
                            <span class="text-zinc-500 text-xs md:text-sm">${audioTracks.length} tracks</span>
                            <button onclick="shuffleAll()" class="bg-orange-500 text-black px-3 md:px-4 py-2 rounded-full text-xs md:text-sm font-bold hover:bg-orange-400 transition flex items-center">
                                <i class="fas fa-play mr-2"></i> Play All
                            </button>
                        </div>
                    </div>
                    <div class="space-y-1">
                        ${audioTracks.length ? audioTracks.map((item, i) => renderListRow(item, i)).join('') : '<p class="text-center text-zinc-600 py-12">No tracks found</p>'}
                    </div>
                `;
            } else if (currentView === 'videos') {
                container.innerHTML = `
                    <div class="flex items-center justify-between mb-4 md:mb-6">
                        <h2 class="text-2xl md:text-3xl font-black tracking-tight">Videos</h2>
                        <span class="text-zinc-500 text-xs md:text-sm">${videoTracks.length} videos</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-3">
                        ${videoTracks.length ? videoTracks.map(item => renderVideoCard(item)).join('') : '<p class="text-center col-span-full text-zinc-600 py-12">No videos found</p>'}
                    </div>
                `;
            } else if (currentView === 'playlists') {
                container.innerHTML = `
                    <h2 class="text-2xl md:text-3xl font-black mb-6 md:mb-8">Playlists</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div onclick="playFavorites()" class="bg-gradient-to-br from-orange-600/20 to-orange-900/10 border border-orange-500/20 p-6 rounded-2xl cursor-pointer hover:border-orange-500 transition">
                            <i class="fas fa-heart text-3xl text-orange-500 mb-4"></i>
                            <h3 class="font-bold">All Tracks</h3>
                            <p class="text-sm text-zinc-500">${mediaLibrary.length} items</p>
                        </div>
                        <div class="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl opacity-50">
                            <i class="fas fa-plus text-3xl text-zinc-600 mb-4"></i>
                            <h3 class="font-bold text-zinc-500">Create Playlist</h3>
                            <p class="text-sm text-zinc-600">Coming soon</p>
                        </div>
                    </div>
                `;
            }
        }

        // ========== RENDER COMPONENTS ==========
        function renderGridCard(item, index) {
            const isPlaying = playQueue[currentTrackIndex]?.id === item.id;
            return `
                <div class="bg-zinc-900 rounded-lg overflow-hidden border border-zinc-800 hover:border-orange-500/50 group transition cursor-pointer ${isPlaying ? 'border-orange-500' : ''}" onclick="playFromLibrary(${item.id})">
                    <div class="aspect-square relative overflow-hidden">
                        ${item.type === 'video' && item.src ?
                    `<video src="${item.src}" class="w-full h-full object-cover" muted></video>` :
                    `<img src="${item.coverArt || generatePlaceholder(item.name)}" class="w-full h-full object-cover">`
                }
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition">
                            <i class="fas fa-play text-white text-xl"></i>
                        </div>
                        ${isPlaying ? '<div class="absolute top-1 right-1 w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>' : ''}
                    </div>
                    <div class="p-2">
                        <div class="font-medium truncate text-xs">${item.name}</div>
                        <div class="text-[10px] text-zinc-500 truncate">${item.artist || 'Unknown'}</div>
                    </div>
                </div>
            `;
        }

        function renderListRow(item, index) {
            const isPlaying = playQueue[currentTrackIndex]?.id === item.id;
            return `
                <div class="group flex items-center ${isPlaying ? 'now-playing' : 'bg-zinc-950 hover:bg-zinc-900/50'} p-2 md:p-3 rounded-lg transition cursor-pointer border border-transparent hover:border-zinc-800" onclick="playFromLibrary(${item.id})">
                    <div class="w-6 md:w-8 text-center text-zinc-600 text-xs md:text-sm mr-2 md:mr-3 shrink-0">${isPlaying ? '<i class="fas fa-volume-up text-orange-500"></i>' : index + 1}</div>
                    <div class="relative w-8 h-8 md:w-10 md:h-10 mr-2 md:mr-3 shrink-0">
                        <img src="${item.coverArt || generatePlaceholder(item.name)}" class="w-full h-full object-cover rounded bg-zinc-800">
                    </div>
                    <div class="flex-1 overflow-hidden min-w-0">
                        <div class="font-medium truncate text-xs md:text-sm ${isPlaying ? 'text-orange-500' : ''}">${item.name}</div>
                        <div class="text-[10px] md:text-xs text-zinc-500 truncate">${item.artist || 'Unknown'}</div>
                    </div>
                    <div class="hidden md:block text-xs text-zinc-600 mr-4 shrink-0">${item.album || ''}</div>
                </div>
            `;
        }

        function renderVideoCard(item) {
            return `
                <div class="bg-zinc-900 rounded-lg overflow-hidden border border-zinc-800 hover:border-orange-500 group transition cursor-pointer" onclick="playMedia(${item.id})">
                    <div class="aspect-video video-thumb flex items-center justify-center relative overflow-hidden">
                        ${item.src ?
                    `<video src="${item.src}" class="w-full h-full object-cover" muted></video>` :
                    `<i class="fas fa-video text-2xl text-zinc-700"></i>`
                }
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition">
                            <i class="fas fa-play text-xl"></i>
                        </div>
                    </div>
                    <div class="p-2">
                        <div class="font-medium truncate text-xs">${item.name}</div>
                        <div class="text-[10px] text-zinc-500 truncate">${item.artist || 'Video'}</div>
                    </div>
                </div>
            `;
        }

        function generatePlaceholder(title) {
            const colors = ['ff7a00', '00aaff', 'aa00ff', '00ff7a', 'ff0077'];
            const color = colors[Math.abs(title.charCodeAt(0)) % colors.length];
            return `https://placehold.co/300x300/111/${color}?text=${encodeURIComponent(title.slice(0, 8))}`;
        }

        // ========== PLAYBACK LOGIC (Unchanged) ==========
        function playFromLibrary(id) {
            const allTracks = filteredLibrary.filter(m => m.type === 'audio' || m.src);
            playQueue = [...allTracks];
            currentTrackIndex = playQueue.findIndex(t => t.id === id);
            if (currentTrackIndex === -1) currentTrackIndex = 0;
            playCurrentTrack();
        }

        function shuffleAll() {
            const allTracks = filteredLibrary.filter(m => m.type === 'audio' || m.src);
            playQueue = [...allTracks].sort(() => Math.random() - 0.5);
            currentTrackIndex = 0;
            isShuffled = true;
            document.getElementById('shuffle-btn').classList.add('text-orange-500');
            playCurrentTrack();
        }

        function playFavorites() {
            shuffleAll();
        }

        async function playCurrentTrack() {
            if (currentTrackIndex < 0 || currentTrackIndex >= playQueue.length) return;

            const item = playQueue[currentTrackIndex];
            if (!item.src && !item.blob) return;

            const url = item.blob ? URL.createObjectURL(item.blob) : item.src;
            
            // For video types played as audio (if desired) or simple audio
            audioPlayer.src = url;
            audioPlayer.play();
            updatePlayerUI(item);
            renderCurrentView(); // Update now-playing indicators
        }

        function updatePlayerUI(item) {
            document.getElementById('player-title').innerText = item.name;
            document.getElementById('player-artist').innerText = item.artist || 'Unknown';
            document.getElementById('player-cover').src = item.coverArt || generatePlaceholder(item.name);
            audioBar.classList.remove('translate-y-full');
            updatePlayButton();
        }

        async function playMedia(id) {
            const item = mediaLibrary.find(m => m.id === id);
            if (!item) return;

            const url = item.src;

            if (item.type === 'video') {
                audioPlayer.pause();
                videoPlayer.src = url;
                document.getElementById('video-overlay').classList.remove('hidden');
                document.getElementById('video-overlay-title').innerText = item.name;
                videoPlayer.play();
            } else {
                playFromLibrary(id);
            }
        }

        function playNext() {
            if (repeatMode === 2) {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
                return;
            }
            currentTrackIndex++;
            if (currentTrackIndex >= playQueue.length) {
                currentTrackIndex = repeatMode === 1 ? 0 : playQueue.length - 1;
                if (repeatMode !== 1) return;
            }
            playCurrentTrack();
        }

        function playPrevious() {
            if (audioPlayer.currentTime > 3) {
                audioPlayer.currentTime = 0;
                return;
            }
            currentTrackIndex--;
            if (currentTrackIndex < 0) currentTrackIndex = playQueue.length - 1;
            playCurrentTrack();
        }

        function togglePlay() {
            if (audioPlayer.paused) {
                if (!audioPlayer.src && playQueue.length === 0) {
                    shuffleAll();
                } else {
                    audioPlayer.play();
                }
            } else {
                audioPlayer.pause();
            }
            updatePlayButton();
        }

        function updatePlayButton() {
            const btn = document.getElementById('player-play-btn');
            const isPaused = audioPlayer.paused;
            btn.innerHTML = isPaused ? '<i class="fas fa-play ml-1"></i>' : '<i class="fas fa-pause"></i>';
            if(waveform) waveform.classList.toggle('waveform-paused', isPaused);
        }

        function toggleShuffle() {
            isShuffled = !isShuffled;
            document.getElementById('shuffle-btn').classList.toggle('text-orange-500', isShuffled);
            if (isShuffled && playQueue.length > 0) {
                const current = playQueue[currentTrackIndex];
                playQueue = playQueue.sort(() => Math.random() - 0.5);
                currentTrackIndex = playQueue.findIndex(t => t.id === current.id);
            }
        }

        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3;
            const btn = document.getElementById('repeat-btn');
            btn.classList.toggle('text-orange-500', repeatMode > 0);
            btn.innerHTML = repeatMode === 2 ? '<i class="fas fa-redo text-sm"></i><span class="text-[8px] absolute">1</span>' : '<i class="fas fa-redo text-sm"></i>';
        }

        function seekMedia(val) {
            audioPlayer.currentTime = val;
        }

        function setVolume(val) {
            audioPlayer.volume = val;
            videoPlayer.volume = val;
        }

        function closeVideo() {
            videoPlayer.pause();
            document.getElementById('video-overlay').classList.add('hidden');
        }

        // ========== QUEUE ==========
        function toggleQueue() {
            const panel = document.getElementById('queue-panel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                renderQueue();
            }
        }

        function renderQueue() {
            const list = document.getElementById('queue-list');
            const upcoming = playQueue.slice(currentTrackIndex + 1, currentTrackIndex + 10);

            list.innerHTML = upcoming.length ? upcoming.map((item, i) => `
                <div class="flex items-center p-2 rounded hover:bg-zinc-800 cursor-pointer" onclick="jumpToQueue(${currentTrackIndex + 1 + i})">
                    <span class="text-zinc-600 text-xs w-6">${i + 1}</span>
                    <img src="${item.coverArt || generatePlaceholder(item.name)}" class="w-8 h-8 rounded mr-3 object-cover">
                    <div class="flex-1 overflow-hidden">
                        <div class="text-sm truncate">${item.name}</div>
                        <div class="text-[10px] text-zinc-500">${item.artist || 'Unknown'}</div>
                    </div>
                </div>
            `).join('') : '<p class="text-center text-zinc-600 p-4 text-sm">Queue empty</p>';
        }

        function jumpToQueue(index) {
            currentTrackIndex = index;
            playCurrentTrack();
            document.getElementById('queue-panel').classList.add('hidden');
        }

        // ========== FILE UPLOAD ==========
        async function triggerUpload() {
            document.getElementById('file-upload').click();
        }

        document.getElementById('file-upload').addEventListener('change', async (e) => {
            // Upload logic handled by IndexedDB in previous versions or future updates
        });
        
        // Listener updates
        audioPlayer.ontimeupdate = () => {
            const cur = audioPlayer.currentTime;
            const dur = audioPlayer.duration || 0;
            const curEl = document.getElementById('player-current');
            const durEl = document.getElementById('player-duration');
            const seekEl = document.getElementById('player-seek');
            
            if(curEl) curEl.innerText = formatTime(cur);
            if(durEl) durEl.innerText = formatTime(dur);
            if(seekEl) {
                seekEl.max = dur;
                seekEl.value = cur;
            }
        };

        audioPlayer.onplay = () => updatePlayButton();
        audioPlayer.onpause = () => updatePlayButton();
        audioPlayer.onended = () => playNext();

        function formatTime(secs) {
            const m = Math.floor(secs / 60);
            const s = Math.floor(secs % 60);
            return `${m}:${s < 10 ? '0' + s : s}`;
        }
    </script>
</body>
</html>